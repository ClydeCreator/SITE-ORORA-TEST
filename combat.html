<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combat - ORORA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Simulateur de combat Orora - Affrontez vos amis !">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ORORA">
    
    <!-- Favicon et ic√¥nes -->
    <link rel="icon" type="image/png" href="icons/IconApp.png">
    <link rel="apple-touch-icon" href="icons/AppImages/ios/180.png">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1, h2, h3, .player-name, .btn-text {
            font-family: 'Bebas Neue', 'Arial Black', sans-serif;
            letter-spacing: 1px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .logo {
            height: 60px;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3));
        }

        .page-title {
            font-size: 2.5em;
            background: linear-gradient(135deg, #ff6ec7, #7873f5, #4aeadc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Container principal */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Phase de s√©lection */
        .selection-phase {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding: 40px 20px;
        }

        .selection-title {
            font-size: 2em;
            text-align: center;
            margin-bottom: 10px;
        }

        .selection-grid {
            display: flex;
            gap: 60px;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
        }

        .player-selection {
            flex: 1;
            max-width: 500px;
            min-width: 300px;
        }

        .player-label {
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 15px;
            color: #4aeadc;
        }

        .player-label.p2 {
            color: #ff6ec7;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid #333;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
        }

        .character-list {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .character-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .character-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .character-option.selected {
            background: rgba(74, 234, 220, 0.2);
            border-left: 4px solid #4aeadc;
        }

        .character-option.selected.p2 {
            background: rgba(255, 110, 199, 0.2);
            border-left: 4px solid #ff6ec7;
        }

        .character-option img {
            width: 50px;
            height: 67px;
            object-fit: cover;
            border-radius: 5px;
        }

        .character-option-info {
            flex: 1;
        }

        .character-option-name {
            font-weight: 600;
            font-size: 1.1em;
        }

        .character-option-stats {
            font-size: 0.85em;
            color: #888;
        }

        .faction-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .faction-dot.alliance { background: #3498db; }
        .faction-dot.rebellion { background: #e74c3c; }
        .faction-dot.trefonds { background: #2ecc71; }

        /* Aper√ßu de la s√©lection */
        .selection-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .preview-card {
            width: 180px;
            height: 240px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 3px dashed rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5em;
            color: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .preview-card.filled {
            border-style: solid;
        }

        .preview-card.p1.filled {
            border-color: #4aeadc;
            box-shadow: 0 0 30px rgba(74, 234, 220, 0.3);
        }

        .preview-card.p2.filled {
            border-color: #ff6ec7;
            box-shadow: 0 0 30px rgba(255, 110, 199, 0.3);
        }

        .preview-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .vs-symbol {
            font-size: 3em;
            color: #f39c12;
            text-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
        }

        /* Bouton de lancement */
        .start-battle-btn {
            padding: 20px 60px;
            font-size: 1.8em;
            font-family: 'Bebas Neue', sans-serif;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 30px rgba(243, 156, 18, 0.4);
            margin-top: 30px;
            letter-spacing: 2px;
        }

        .start-battle-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(243, 156, 18, 0.6);
        }

        .start-battle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Phase de combat */
        .battle-phase {
            display: none;
            padding: 20px;
        }

        .battle-arena {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            min-height: calc(100vh - 200px);
            flex-wrap: wrap;
        }

        /* Combattant */
        .combatant {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .combatant.active .combat-card {
            animation: pulse-glow 1s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(243, 156, 18, 0.5); }
            50% { box-shadow: 0 0 40px rgba(243, 156, 18, 0.8); }
        }

        .hp-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hp-heart {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .hp-heart svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.5));
        }

        .hp-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .damage-text {
            position: absolute;
            top: -30px;
            right: -20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8em;
            color: #ff4444;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        .damage-text.show {
            animation: damage-pop 1s ease-out forwards;
        }

        @keyframes damage-pop {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translateY(-10px) scale(1.2);
            }
            80% {
                opacity: 1;
                transform: translateY(-20px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-30px) scale(0.8);
            }
        }

        .dodge-text {
            position: absolute;
            top: -30px;
            right: -30px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5em;
            color: #4aeadc;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        .dodge-text.show {
            animation: dodge-pop 1s ease-out forwards;
        }

        @keyframes dodge-pop {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translateY(-10px) scale(1.1);
            }
            80% {
                opacity: 1;
                transform: translateY(-20px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-30px) scale(0.8);
            }
        }

        .combat-card {
            width: 300px;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 3px solid transparent;
        }

        .combat-card:hover:not(.disabled) {
            transform: scale(1.02);
        }

        .combat-card.disabled {
            cursor: not-allowed;
            filter: brightness(0.7);
        }

        .combat-card.alliance { border-color: #3498db; }
        .combat-card.rebellion { border-color: #e74c3c; }
        .combat-card.trefonds { border-color: #2ecc71; }

        .combat-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .combat-card.ko {
            filter: grayscale(100%) brightness(0.5);
            transform: rotate(5deg);
        }

        .player-name {
            font-size: 2.5em;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* Zone centrale */
        .battle-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .sword-container {
            width: 80px;
            height: 100px;
            position: relative;
        }

        .sword {
            width: 100%;
            height: 100%;
            transition: transform 0.3s ease;
        }

        .sword.point-left {
            transform: rotate(-45deg);
        }

        .sword.point-right {
            transform: rotate(45deg);
        }

        .auto-battle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auto-battle-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #4aeadc;
        }

        .auto-battle-label {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2em;
            letter-spacing: 1px;
            cursor: pointer;
        }

        /* Log de combat */
        .battle-log {
            max-width: 600px;
            margin: 20px auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            font-size: 0.9em;
            animation: slide-in 0.3s ease;
        }

        @keyframes slide-in {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-entry.attack {
            background: rgba(243, 156, 18, 0.2);
            border-left: 3px solid #f39c12;
        }

        .log-entry.dodge {
            background: rgba(74, 234, 220, 0.2);
            border-left: 3px solid #4aeadc;
        }

        .log-entry.victory {
            background: rgba(46, 204, 113, 0.2);
            border-left: 3px solid #2ecc71;
        }

        .log-entry.info {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid #888;
        }

        /* Stats d√©taill√©es */
        .combat-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            min-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-label {
            color: #888;
        }

        .stat-value {
            font-weight: 600;
        }

        .stat-value.bonus {
            color: #2ecc71;
        }

        .stat-value.malus {
            color: #e74c3c;
        }

        /* √âcran de victoire */
        .victory-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 30px;
        }

        .victory-overlay.show {
            display: flex;
            animation: fade-in 0.5s ease;
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .victory-title {
            font-size: 4em;
            text-align: center;
            background: linear-gradient(135deg, #f39c12, #f1c40f, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: victory-glow 1s infinite alternate;
        }

        @keyframes victory-glow {
            from { filter: drop-shadow(0 0 10px rgba(243, 156, 18, 0.5)); }
            to { filter: drop-shadow(0 0 30px rgba(243, 156, 18, 0.8)); }
        }

        .winner-card {
            width: 250px;
            height: 333px;
            border-radius: 15px;
            overflow: hidden;
            border: 4px solid #f39c12;
            box-shadow: 0 0 50px rgba(243, 156, 18, 0.5);
        }

        .winner-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .winner-name {
            font-size: 3em;
        }

        .rematch-btn, .new-battle-btn {
            padding: 15px 40px;
            font-size: 1.5em;
            font-family: 'Bebas Neue', sans-serif;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
        }

        .rematch-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .new-battle-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .rematch-btn:hover, .new-battle-btn:hover {
            transform: scale(1.05);
        }

        .victory-buttons {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Turn indicator */
        .turn-indicator {
            text-align: center;
            font-size: 1.5em;
            padding: 15px;
            background: rgba(243, 156, 18, 0.2);
            border-radius: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .turn-indicator .turn-name {
            color: #f39c12;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2em;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .battle-arena {
                flex-direction: column;
                gap: 20px;
            }

            .combatant {
                order: 2;
            }

            .combatant:first-child {
                order: 3;
            }

            .battle-center {
                order: 2;
            }

            .combat-card {
                width: 250px;
                height: 333px;
            }

            .sword-container {
                transform: rotate(90deg);
            }

            .sword.point-left {
                transform: rotate(-45deg);
            }

            .sword.point-right {
                transform: rotate(45deg);
            }

            .player-name {
                font-size: 2em;
            }

            .selection-grid {
                flex-direction: column;
                gap: 30px;
            }

            .vs-symbol {
                font-size: 2em;
            }

            .preview-card {
                width: 120px;
                height: 160px;
            }
        }

        @media (max-width: 480px) {
            .combat-card {
                width: 200px;
                height: 267px;
            }

            .page-title {
                font-size: 1.8em;
            }

            .hp-heart {
                width: 50px;
                height: 50px;
            }

            .hp-value {
                font-size: 1.2em;
            }

            .player-name {
                font-size: 1.5em;
            }

            .back-btn {
                position: relative;
                left: auto;
                margin-bottom: 10px;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="back-btn">‚Üê Retour</a>
            <img src="logo.png" alt="ORORA" class="logo">
            <h1 class="page-title">SIMULATEUR DE COMBAT</h1>
        </div>
    </header>

    <!-- Phase de s√©lection -->
    <div id="selectionPhase" class="selection-phase">
        <h2 class="selection-title">Choisissez vos combattants</h2>
        
        <div class="selection-grid">
            <!-- Joueur 1 -->
            <div class="player-selection">
                <div class="player-label">JOUEUR 1</div>
                <div class="search-box">
                    <input type="text" class="search-input" id="searchP1" placeholder="Rechercher un personnage...">
                </div>
                <div class="character-list" id="listP1"></div>
            </div>
            
            <!-- Joueur 2 -->
            <div class="player-selection">
                <div class="player-label p2">JOUEUR 2</div>
                <div class="search-box">
                    <input type="text" class="search-input" id="searchP2" placeholder="Rechercher un personnage...">
                </div>
                <div class="character-list" id="listP2"></div>
            </div>
        </div>

        <!-- Aper√ßu de la s√©lection -->
        <div class="selection-preview">
            <div class="preview-card p1" id="previewP1">?</div>
            <div class="vs-symbol">VS</div>
            <div class="preview-card p2" id="previewP2">?</div>
        </div>

        <button class="start-battle-btn" id="startBattleBtn" disabled>‚öîÔ∏è LANCER LE COMBAT ‚öîÔ∏è</button>
    </div>

    <!-- Phase de combat -->
    <div id="battlePhase" class="battle-phase">
        <div class="turn-indicator" id="turnIndicator">
            C'est au tour de <span class="turn-name" id="turnName">...</span>
        </div>

        <div class="battle-arena">
            <!-- Combattant 1 -->
            <div class="combatant" id="combatant1">
                <div class="hp-container">
                    <div class="hp-heart">
                        <svg viewBox="0 0 24 24" fill="#2ecc71">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        <span class="hp-value" id="hp1">0</span>
                    </div>
                    <div class="damage-text" id="damage1"></div>
                    <div class="dodge-text" id="dodge1">ESQUIVE!</div>
                </div>
                <div class="combat-card" id="card1" onclick="playerAttack(1)">
                    <img id="cardImg1" src="" alt="">
                </div>
                <div class="player-name" id="name1"></div>
            </div>

            <!-- Centre - √âp√©e -->
            <div class="battle-center">
                <div class="sword-container">
                    <svg class="sword" id="battleSword" viewBox="0 0 64 64">
                        <!-- Lame -->
                        <polygon fill="#e0e0e0" points="32,2 38,20 32,18 26,20"/>
                        <polygon fill="#c0c0c0" points="32,18 38,20 38,40 32,38"/>
                        <polygon fill="#d0d0d0" points="32,18 26,20 26,40 32,38"/>
                        <!-- Garde -->
                        <rect fill="#8B4513" x="22" y="40" width="20" height="4" rx="1"/>
                        <!-- Poign√©e -->
                        <rect fill="#654321" x="29" y="44" width="6" height="14" rx="1"/>
                        <!-- Pommeau -->
                        <circle fill="#FFD700" cx="32" cy="60" r="3"/>
                        <!-- Reflet -->
                        <polygon fill="rgba(255,255,255,0.3)" points="30,4 32,2 34,4 34,18 30,18"/>
                    </svg>
                </div>
                <div class="auto-battle-container">
                    <input type="checkbox" class="auto-battle-checkbox" id="autoBattle">
                    <label class="auto-battle-label" for="autoBattle">COMBAT AUTOMATIQUE</label>
                </div>
            </div>

            <!-- Combattant 2 -->
            <div class="combatant" id="combatant2">
                <div class="hp-container">
                    <div class="hp-heart">
                        <svg viewBox="0 0 24 24" fill="#2ecc71">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        <span class="hp-value" id="hp2">0</span>
                    </div>
                    <div class="damage-text" id="damage2"></div>
                    <div class="dodge-text" id="dodge2">ESQUIVE!</div>
                </div>
                <div class="combat-card" id="card2" onclick="playerAttack(2)">
                    <img id="cardImg2" src="" alt="">
                </div>
                <div class="player-name" id="name2"></div>
            </div>
        </div>

        <!-- Log de combat -->
        <div class="battle-log" id="battleLog"></div>

        <!-- Stats d√©taill√©es -->
        <div class="combat-stats" id="combatStats"></div>
    </div>

    <!-- √âcran de victoire -->
    <div class="victory-overlay" id="victoryOverlay">
        <h2 class="victory-title">üèÜ VICTOIRE ! üèÜ</h2>
        <div class="winner-card" id="winnerCard">
            <img id="winnerImg" src="" alt="">
        </div>
        <div class="winner-name" id="winnerName"></div>
        <div class="victory-buttons">
            <button class="rematch-btn" onclick="rematch()">üîÑ REVANCHE</button>
            <button class="new-battle-btn" onclick="newBattle()">‚öîÔ∏è NOUVEAU COMBAT</button>
        </div>
    </div>

    <script>
        // Variables globales
        let allCharacters = [];
        let selectedP1 = null;
        let selectedP2 = null;
        let fighter1 = null;
        let fighter2 = null;
        let currentTurn = 1;
        let battleEnded = false;
        let autoMode = false;
        let lastAttacker = null;

        // Fonction pour parser un fichier INI
        function parseINI(text) {
            const lines = text.split('\n');
            const result = {};
            let currentSection = null;

            for (let line of lines) {
                line = line.trim();
                if (!line || line.startsWith(';') || line.startsWith('#')) continue;
                
                if (line.startsWith('[') && line.endsWith(']')) {
                    currentSection = line.slice(1, -1).trim();
                    result[currentSection] = {};
                    continue;
                }
                
                const equalIndex = line.indexOf('=');
                if (equalIndex > -1 && currentSection) {
                    const key = line.slice(0, equalIndex).trim();
                    let value = line.slice(equalIndex + 1).trim();
                    
                    if ((value.startsWith('"') && value.endsWith('"')) || 
                        (value.startsWith("'") && value.endsWith("'"))) {
                        value = value.slice(1, -1);
                    }
                    
                    result[currentSection][key] = value;
                }
            }
            
            return result;
        }

        // Charger un fichier INI
        async function loadINI(filepath) {
            try {
                const response = await fetch(filepath);
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                const text = await response.text();
                return parseINI(text);
            } catch (error) {
                console.error(`Erreur lors du chargement de ${filepath}:`, error);
                return {};
            }
        }

        // Charger les personnages
        async function loadCharacters() {
            const factions = [
                { name: 'Alliance', file: './data/alliance.ini', class: 'alliance' },
                { name: 'R√©bellion', file: './data/rebellion.ini', class: 'rebellion' },
                { name: 'Tr√©fonds', file: './data/trefonds.ini', class: 'trefonds' }
            ];

            const characters = [];

            for (const faction of factions) {
                const data = await loadINI(faction.file);
                
                for (const [name, stats] of Object.entries(data)) {
                    if (stats['zz CreationCarte'] === 'Faite') {
                        characters.push({
                            name: name,
                            faction: faction.name,
                            factionClass: faction.class,
                            niveau: parseInt(stats.Niveau) || 0,
                            attaque: parseInt(stats.Attaque) || 0,
                            defense: parseInt(stats.Defense) || 0,
                            strategie: parseInt(stats.Strategie) || 0,
                            vitesse: parseInt(stats.Vitesse) || 0,
                            pv: parseInt(stats.PV) || 0,
                            pointsTotaux: parseInt(stats.PointsTotaux) || 0
                        });
                    }
                }
            }

            characters.sort((a, b) => b.pointsTotaux - a.pointsTotaux);
            return characters;
        }

        // Afficher la liste des personnages
        function displayCharacterList(characters, containerId, player) {
            const container = document.getElementById(containerId);
            container.innerHTML = characters.map(char => `
                <div class="character-option ${player === 2 ? 'p2' : ''}" 
                     data-name="${char.name}" 
                     onclick="selectCharacter('${char.name}', ${player})">
                    <img src="./cards/${char.name}.png" alt="${char.name}" 
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 50 67%22%3E%3Crect fill=%22%23333%22 width=%2250%22 height=%2267%22/%3E%3C/svg%3E'">
                    <div class="character-option-info">
                        <div class="character-option-name">${char.name}</div>
                        <div class="character-option-stats">
                            Niv.${char.niveau} ‚Ä¢ ATK:${char.attaque} ‚Ä¢ DEF:${char.defense}
                        </div>
                    </div>
                    <div class="faction-dot ${char.factionClass}"></div>
                </div>
            `).join('');
        }

        // S√©lectionner un personnage
        function selectCharacter(name, player) {
            const char = allCharacters.find(c => c.name === name);
            if (!char) return;

            const listId = player === 1 ? 'listP1' : 'listP2';
            const previewId = player === 1 ? 'previewP1' : 'previewP2';
            const otherSelection = player === 1 ? selectedP2 : selectedP1;

            // D√©selectionner l'ancien
            document.querySelectorAll(`#${listId} .character-option`).forEach(opt => {
                opt.classList.remove('selected');
            });

            // S√©lectionner le nouveau
            const option = document.querySelector(`#${listId} .character-option[data-name="${name}"]`);
            if (option) {
                option.classList.add('selected');
            }

            // Mettre √† jour l'aper√ßu
            const preview = document.getElementById(previewId);
            preview.innerHTML = `<img src="./cards/${name}.png" alt="${name}">`;
            preview.classList.add('filled');

            // Stocker la s√©lection
            if (player === 1) {
                selectedP1 = char;
            } else {
                selectedP2 = char;
            }

            // Activer le bouton si les deux sont s√©lectionn√©s
            const startBtn = document.getElementById('startBattleBtn');
            startBtn.disabled = !(selectedP1 && selectedP2);
        }

        // Filtrer la liste
        function filterList(searchTerm, listId, player) {
            const filtered = allCharacters.filter(char => 
                char.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            displayCharacterList(filtered, listId, player);

            // Remettre la s√©lection si elle existe
            const selected = player === 1 ? selectedP1 : selectedP2;
            if (selected) {
                const option = document.querySelector(`#${listId} .character-option[data-name="${selected.name}"]`);
                if (option) {
                    option.classList.add('selected');
                }
            }
        }

        // Calculer la chance d'esquive selon la vitesse
        function getDodgeChance(vitesse) {
            if (vitesse >= 512) return 1/6;
            if (vitesse >= 256) return 1/8;
            if (vitesse >= 128) return 1/10;
            if (vitesse >= 64) return 1/12;
            if (vitesse >= 32) return 1/20;
            return 1/30;
        }

        // Calculer les bonus de combat
        function calculateBonuses(attacker, defender) {
            // Bonus de strat√©gie (attaque)
            const strategieDiff = attacker.strategie - defender.strategie;
            let bonusStrategie = strategieDiff > 0 ? Math.min(strategieDiff, 60) : 0; // Cap √† 60%

            // Bonus de d√©fense
            const defenseDiff = defender.defense - attacker.defense;
            let bonusDefense = defenseDiff > 0 ? Math.min(defenseDiff, 60) : 0; // Cap √† 60%

            return { bonusStrategie, bonusDefense };
        }

        // Effectuer une attaque
        function performAttack(attackerId) {
            if (battleEnded) return;

            const attacker = attackerId === 1 ? fighter1 : fighter2;
            const defender = attackerId === 1 ? fighter2 : fighter1;
            const defenderHpId = attackerId === 1 ? 'hp2' : 'hp1';
            const damageTextId = attackerId === 1 ? 'damage2' : 'damage1';
            const dodgeTextId = attackerId === 1 ? 'dodge2' : 'dodge1';

            // V√©rifier si esquive
            const dodgeChance = getDodgeChance(defender.vitesse);
            const isDodge = Math.random() < dodgeChance;

            if (isDodge) {
                // Esquive !
                showDodge(dodgeTextId);
                addLog(`${defender.name} esquive l'attaque de ${attacker.name} !`, 'dodge');
                
                // En cas d'esquive, l'attaquant peut r√©-attaquer
                // On ne change pas le tour
                updateTurnIndicator(attackerId);
                
                if (autoMode && !battleEnded) {
                    setTimeout(() => performAttack(attackerId), 1000);
                }
                return;
            }

            // Calculer les d√©g√¢ts
            const baseAttack = Math.floor(Math.random() * (attacker.attaque + 1));
            const { bonusStrategie, bonusDefense } = calculateBonuses(attacker, defender);
            
            // Appliquer les bonus
            let finalDamage = baseAttack;
            finalDamage += Math.floor(baseAttack * bonusStrategie / 100);
            finalDamage -= Math.floor(baseAttack * bonusDefense / 100);
            finalDamage = Math.max(0, finalDamage);

            // Appliquer les d√©g√¢ts
            defender.currentHp -= finalDamage;
            if (defender.currentHp < 0) defender.currentHp = 0;

            // Afficher les d√©g√¢ts
            showDamage(damageTextId, finalDamage);
            document.getElementById(defenderHpId).textContent = defender.currentHp;

            // Log
            let logMessage = `${attacker.name} inflige ${finalDamage} d√©g√¢ts √† ${defender.name}`;
            if (bonusStrategie > 0) logMessage += ` (+${bonusStrategie}% strat√©gie)`;
            if (bonusDefense > 0) logMessage += ` (-${bonusDefense}% d√©fense)`;
            addLog(logMessage, 'attack');

            // V√©rifier si KO
            if (defender.currentHp <= 0) {
                endBattle(attackerId);
                return;
            }

            // Changer de tour
            lastAttacker = attackerId;
            const nextTurn = attackerId === 1 ? 2 : 1;
            currentTurn = nextTurn;
            updateTurnIndicator(nextTurn);

            // Pointer l'√©p√©e
            const sword = document.getElementById('battleSword');
            sword.classList.remove('point-left', 'point-right');
            sword.classList.add(nextTurn === 1 ? 'point-left' : 'point-right');

            // Mode auto
            if (autoMode && !battleEnded) {
                setTimeout(() => performAttack(nextTurn), 1000);
            }
        }

        // Clic du joueur pour attaquer
        function playerAttack(playerId) {
            if (battleEnded) return;
            if (autoMode) return;
            if (playerId !== currentTurn) return;

            performAttack(playerId);
        }

        // Afficher les d√©g√¢ts
        function showDamage(elementId, damage) {
            const element = document.getElementById(elementId);
            element.textContent = `-${damage}`;
            element.classList.remove('show');
            void element.offsetWidth; // Force reflow
            element.classList.add('show');
        }

        // Afficher l'esquive
        function showDodge(elementId) {
            const element = document.getElementById(elementId);
            element.classList.remove('show');
            void element.offsetWidth;
            element.classList.add('show');
        }

        // Mettre √† jour l'indicateur de tour
        function updateTurnIndicator(playerId) {
            const turnName = document.getElementById('turnName');
            const fighter = playerId === 1 ? fighter1 : fighter2;
            turnName.textContent = fighter.name;

            // Mettre √† jour les classes actives
            document.getElementById('combatant1').classList.toggle('active', playerId === 1);
            document.getElementById('combatant2').classList.toggle('active', playerId === 2);

            // D√©sactiver/activer les cartes
            document.getElementById('card1').classList.toggle('disabled', playerId !== 1);
            document.getElementById('card2').classList.toggle('disabled', playerId !== 2);
        }

        // Ajouter au log
        function addLog(message, type) {
            const log = document.getElementById('battleLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = message;
            log.insertBefore(entry, log.firstChild);
        }

        // Fin du combat
        function endBattle(winnerId) {
            battleEnded = true;
            const winner = winnerId === 1 ? fighter1 : fighter2;
            const loser = winnerId === 1 ? fighter2 : fighter1;
            const loserCardId = winnerId === 1 ? 'card2' : 'card1';

            // Marquer le perdant comme KO
            document.getElementById(loserCardId).classList.add('ko');

            // Log de victoire
            addLog(`üèÜ ${winner.name} remporte le combat !`, 'victory');

            // Afficher l'√©cran de victoire apr√®s un d√©lai
            setTimeout(() => {
                document.getElementById('winnerImg').src = `./cards/${winner.name}.png`;
                document.getElementById('winnerName').textContent = winner.name;
                document.getElementById('victoryOverlay').classList.add('show');
            }, 1000);
        }

        // Lancer le combat
        function startBattle() {
            if (!selectedP1 || !selectedP2) return;

            // Initialiser les combattants
            fighter1 = { ...selectedP1, currentHp: selectedP1.pv * 5 };
            fighter2 = { ...selectedP2, currentHp: selectedP2.pv * 5 };

            // Afficher les cartes
            document.getElementById('cardImg1').src = `./cards/${fighter1.name}.png`;
            document.getElementById('cardImg2').src = `./cards/${fighter2.name}.png`;
            document.getElementById('name1').textContent = fighter1.name;
            document.getElementById('name2').textContent = fighter2.name;
            document.getElementById('hp1').textContent = fighter1.currentHp;
            document.getElementById('hp2').textContent = fighter2.currentHp;

            // Appliquer les classes de faction
            document.getElementById('card1').className = `combat-card ${fighter1.factionClass}`;
            document.getElementById('card2').className = `combat-card ${fighter2.factionClass}`;

            // D√©terminer qui commence (plus haute vitesse)
            currentTurn = fighter1.vitesse >= fighter2.vitesse ? 1 : 2;
            lastAttacker = null;
            battleEnded = false;

            // Log de d√©but
            addLog(`Combat : ${fighter1.name} VS ${fighter2.name}`, 'info');
            addLog(`${currentTurn === 1 ? fighter1.name : fighter2.name} commence (vitesse sup√©rieure)`, 'info');

            // Afficher les stats
            displayCombatStats();

            // Mettre √† jour l'interface
            updateTurnIndicator(currentTurn);
            const sword = document.getElementById('battleSword');
            sword.classList.remove('point-left', 'point-right');
            sword.classList.add(currentTurn === 1 ? 'point-left' : 'point-right');

            // Passer √† la phase de combat
            document.getElementById('selectionPhase').style.display = 'none';
            document.getElementById('battlePhase').style.display = 'block';

            // Mode auto
            autoMode = document.getElementById('autoBattle').checked;
            if (autoMode) {
                setTimeout(() => performAttack(currentTurn), 1000);
            }
        }

        // Afficher les stats de combat
        function displayCombatStats() {
            const { bonusStrategie: bonus1, bonusDefense: def1 } = calculateBonuses(fighter1, fighter2);
            const { bonusStrategie: bonus2, bonusDefense: def2 } = calculateBonuses(fighter2, fighter1);

            const container = document.getElementById('combatStats');
            container.innerHTML = `
                <div class="stat-card">
                    <h3>${fighter1.name}</h3>
                    <div class="stat-row">
                        <span class="stat-label">PV</span>
                        <span class="stat-value">${fighter1.pv} √ó 5 = ${fighter1.pv * 5}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Attaque</span>
                        <span class="stat-value">0 - ${fighter1.attaque}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Bonus Strat√©gie</span>
                        <span class="stat-value ${bonus1 > 0 ? 'bonus' : ''}">${bonus1 > 0 ? '+' + bonus1 + '%' : '-'}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Bonus D√©fense</span>
                        <span class="stat-value ${def1 > 0 ? 'bonus' : ''}">${def1 > 0 ? '+' + def1 + '%' : '-'}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Chance d'esquive</span>
                        <span class="stat-value">${Math.round(getDodgeChance(fighter1.vitesse) * 100)}%</span>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>${fighter2.name}</h3>
                    <div class="stat-row">
                        <span class="stat-label">PV</span>
                        <span class="stat-value">${fighter2.pv} √ó 5 = ${fighter2.pv * 5}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Attaque</span>
                        <span class="stat-value">0 - ${fighter2.attaque}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Bonus Strat√©gie</span>
                        <span class="stat-value ${bonus2 > 0 ? 'bonus' : ''}">${bonus2 > 0 ? '+' + bonus2 + '%' : '-'}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Bonus D√©fense</span>
                        <span class="stat-value ${def2 > 0 ? 'bonus' : ''}">${def2 > 0 ? '+' + def2 + '%' : '-'}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Chance d'esquive</span>
                        <span class="stat-value">${Math.round(getDodgeChance(fighter2.vitesse) * 100)}%</span>
                    </div>
                </div>
            `;
        }

        // Revanche
        function rematch() {
            document.getElementById('victoryOverlay').classList.remove('show');
            document.getElementById('battleLog').innerHTML = '';
            document.getElementById('card1').classList.remove('ko');
            document.getElementById('card2').classList.remove('ko');
            
            startBattle();
        }

        // Nouveau combat
        function newBattle() {
            document.getElementById('victoryOverlay').classList.remove('show');
            document.getElementById('battlePhase').style.display = 'none';
            document.getElementById('selectionPhase').style.display = 'flex';
            document.getElementById('battleLog').innerHTML = '';
            document.getElementById('card1').classList.remove('ko');
            document.getElementById('card2').classList.remove('ko');
            
            // R√©initialiser les s√©lections
            selectedP1 = null;
            selectedP2 = null;
            document.getElementById('previewP1').innerHTML = '?';
            document.getElementById('previewP1').classList.remove('filled');
            document.getElementById('previewP2').innerHTML = '?';
            document.getElementById('previewP2').classList.remove('filled');
            document.getElementById('startBattleBtn').disabled = true;
            
            // R√©afficher les listes
            displayCharacterList(allCharacters, 'listP1', 1);
            displayCharacterList(allCharacters, 'listP2', 2);
        }

        // Toggle mode auto
        document.getElementById('autoBattle').addEventListener('change', function(e) {
            autoMode = e.target.checked;
            if (autoMode && !battleEnded && document.getElementById('battlePhase').style.display === 'block') {
                performAttack(currentTurn);
            }
        });

        // Initialisation
        async function init() {
            try {
                allCharacters = await loadCharacters();
                displayCharacterList(allCharacters, 'listP1', 1);
                displayCharacterList(allCharacters, 'listP2', 2);
                console.log(`‚úÖ ${allCharacters.length} personnages charg√©s pour le combat`);
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement:', error);
            }
        }

        // Event listeners pour la recherche
        document.getElementById('searchP1').addEventListener('input', function(e) {
            filterList(e.target.value, 'listP1', 1);
        });

        document.getElementById('searchP2').addEventListener('input', function(e) {
            filterList(e.target.value, 'listP2', 2);
        });

        // Bouton de lancement
        document.getElementById('startBattleBtn').addEventListener('click', startBattle);

        // Lancer l'initialisation
        init();
    </script>
</body>
</html>
